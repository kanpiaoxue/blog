#struts2 文件上传（多文件上传） upload
###发表时间：2010-05-27
###分类：
###iteye原始地址：<a href="https://kanpiaoxue.iteye.com/admin/blogs/677025" target="_blank">https://kanpiaoxue.iteye.com/admin/blogs/677025</a>

---

<p>&nbsp;（1）前面的的form JSP 页面<br>&nbsp;&lt;s:form id="formId" action="/operation/saveCompetitionProductReport.do" enctype="multipart/form-data" theme="simple"&gt;<br>&nbsp;<br>&nbsp;&lt;table&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;td colspan="4"&gt;关注度截图：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;input type="file" name="pic"/&gt;&lt;/td&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;/tr&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;tr&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;td colspan="4"&gt;相关检索字：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;input type="file"&nbsp; name="pic"/&gt;&lt;/td&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp; &lt;/tr&gt;<br>&nbsp;&lt;/table&gt;<br>&nbsp;<br>&nbsp;&lt;s:submit/&gt;&lt;s:reset/&gt;<br>&nbsp;&lt;/s:form&gt;&nbsp;<br>&nbsp;&nbsp; <br>&nbsp;（2）struts.xml<br>&nbsp;<br>&nbsp;&nbsp;&nbsp;&lt;interceptors&gt;<br>&nbsp;&nbsp;&nbsp;&lt;interceptor-stack name="imgFileUpload"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;interceptor-ref name="fileUpload"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;param name="allowedTypes"&gt;image/jpeg,image/pjpeg,image/gif,image/x-png&lt;/param&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;param name="maximumSize"&gt;204800&lt;/param&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/interceptor-ref&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;interceptor-ref name="defaultStack"/&gt;<br>&nbsp;&nbsp;&nbsp;&lt;/interceptor-stack&gt;<br>&nbsp;&nbsp;&nbsp; &nbsp;&lt;/interceptors&gt;&nbsp; <br>&nbsp;&nbsp; <br>&nbsp;&nbsp; &lt;action name="saveCompetitionProductReport" class="operationAction" method="saveCompetitionProductReport"&gt;<br>&nbsp;&nbsp;&nbsp;&lt;interceptor-ref name="imgFileUpload"/&gt;&nbsp;&nbsp;&nbsp;&nbsp; &lt;!-- ================= 拦截器的使用 ================ --&gt;<br>&nbsp;&nbsp;&nbsp;&lt;result name="success"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;/jsp/operation/edit/MyJsp.jsp<br>&nbsp;&nbsp;&nbsp;&lt;/result&gt;<br>&nbsp;&nbsp;&nbsp;&lt;result name="error"&gt;/jsp/error.jsp&lt;/result&gt;<br>&nbsp;&nbsp;&lt;/action&gt; &nbsp;<br>&nbsp;&nbsp;<br>&nbsp;（3）Action <br>&nbsp;/*-------------------------------------------------*/<br>&nbsp;private static final int BUFFER_SIZE = 20 * 1024;//文件大小<br>&nbsp;private File[] pic;&nbsp; //对应 &lt;input type="file"&nbsp; name="pic"/&gt;<br>&nbsp;private String[] picFileName; //固定构成格式<br>&nbsp;private String[] picContentType; //固定构成格式<br>&nbsp;/*-------------------------------------------------*/<br>&nbsp;<br>&nbsp;//-------- setter / getter<br>&nbsp;&nbsp;&nbsp;//.......... code here ............<br>&nbsp;<br>&nbsp;/**<br>&nbsp; * 复制文件<br>&nbsp; * @param src<br>&nbsp; * @param dest<br>&nbsp; */<br>&nbsp;private static void copy(File src, File dest){<br>&nbsp;&nbsp;try{<br>&nbsp;&nbsp;&nbsp;InputStream in = null;<br>&nbsp;&nbsp;&nbsp;OutputStream out = null;<br>&nbsp;&nbsp;&nbsp;try{<br>&nbsp;&nbsp;&nbsp;&nbsp;in = new BufferedInputStream(new FileInputStream(src),BUFFER_SIZE);<br>&nbsp;&nbsp;&nbsp;&nbsp;out = new BufferedOutputStream(new FileOutputStream(dest),BUFFER_SIZE);<br>&nbsp;&nbsp;&nbsp;&nbsp;byte[] buffer = new byte[1024];<br>&nbsp;&nbsp;&nbsp;&nbsp;while(in.read(buffer) &gt; 0){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.write(buffer);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;}finally{<br>&nbsp;&nbsp;&nbsp;&nbsp;if(null != in){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in.close();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;if(null != out){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.close();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}catch(Exception e){<br>&nbsp;&nbsp;&nbsp;logger.error("复制文件出错",e);<br>&nbsp;&nbsp;}<br>&nbsp;}</p>
<p>&nbsp;/**<br>&nbsp; * 得到文件的后缀名<br>&nbsp; * @param fileName<br>&nbsp; * @return<br>&nbsp; */<br>&nbsp;private static String getExtention(String fileName){<br>&nbsp;&nbsp;int pos = fileName.lastIndexOf(".");<br>&nbsp;&nbsp;return fileName.substring(pos);<br>&nbsp;}<br>&nbsp;<br>&nbsp;<br>&nbsp;<br>&nbsp;public String saveCompetitionProductReport(){<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;List&lt;String&gt; picUrlList = new ArrayList&lt;String&gt;();//图片在服务器上面的相对位置<br>&nbsp;&nbsp;if(null != pic){<br>&nbsp;&nbsp;&nbsp;for(int i = 0, j = pic.length; i&lt;j; i++){<br>&nbsp;&nbsp;&nbsp;&nbsp;String extention = getExtention(picFileName[i]);<br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp; "/uploadImage" 是 项目下的文件夹，防止上传的文件 图片被成功上传之后，会存放到tomcat的项目/uploadImage 目录下<br>&nbsp;&nbsp;&nbsp;&nbsp;String fileName = ServletActionContext.getServletContext().getRealPath("/uploadImage")+File.separator+new Date().getTime()+ Math.random() + extention;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;//System.out.println("before===================" + fileName +"\t" +picFileName[i]);<br>&nbsp;&nbsp;&nbsp;&nbsp;File imageFile = new File(fileName);<br>&nbsp;&nbsp;&nbsp;&nbsp;copy(pic[i], imageFile);<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;String tmpFileName = fileName.substring(fileName.indexOf(File.separator +"uploadImage"));<br>&nbsp;&nbsp;&nbsp;&nbsp;picUrlList.add(tmpFileName);<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;Boolean saveMainTableDataFlag = operationBusiness.saveCompetitionProductReport(this);<br>&nbsp;&nbsp;&nbsp;if(saveMainTableDataFlag){//当主表保存成功的时候，开始保存明细<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//--------- code here<br>&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;return Action.ACTION_RESULT_SUCCESS;<br>&nbsp;}&nbsp;&nbsp;</p>