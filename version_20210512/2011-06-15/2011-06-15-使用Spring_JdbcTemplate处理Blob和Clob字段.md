#使用Spring JdbcTemplate处理Blob和Clob字段
###发表时间：2011-06-15
###分类：
###iteye原始地址：<a href="https://kanpiaoxue.iteye.com/admin/blogs/1090269" target="_blank">https://kanpiaoxue.iteye.com/admin/blogs/1090269</a>

---

<p><span style=""> </span></p>
<p style="line-height: normal;">spring定义了一个以统一的方式操作各种数据库的Lob类型数据的LobCreator(保存的时候用),同时提供了一个<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>为操作二进制字段和大文本字段提供统一接口访问。&nbsp;<br style="line-height: normal;">举例，例子里面的t_post表中post_text字段是CLOB类型,而post_attach是BLOG类型：</p>
<p style="line-height: normal;">public class PostJdbcDao extends JdbcDaoSupport implements PostDao {<br style="line-height: normal;">private&nbsp;<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>&nbsp;<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>;<br style="line-height: normal;">private DataFieldMaxValueIncrementer incre;<br style="line-height: normal;">public&nbsp;<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>&nbsp;get<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>() {<br style="line-height: normal;">&nbsp;&nbsp; return&nbsp;<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>;<br style="line-height: normal;">}<br style="line-height: normal;">public void set<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>(<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>&nbsp;<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>) {<br style="line-height: normal;">&nbsp;&nbsp; this.<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>&nbsp;=&nbsp;<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>;<br style="line-height: normal;">}<br style="line-height: normal;">public void addPost(final Post post) {&nbsp;&nbsp;<br style="line-height: normal;">&nbsp;&nbsp; String sql = " INSERT INTO t_post(post_id,user_id,post_text,post_attach)"<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp; + " VALUES(?,?,?,?)";<br style="line-height: normal;">&nbsp;&nbsp; getJdbcTemplate().execute(<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp; sql,<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp; new AbstractLobCreatingPreparedStatementCallback(<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>) {<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protected void setValues(PreparedStatement ps,<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LobCreator lobCreator) throws SQLException {<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ps.setInt(1, incre.nextIntValue());&nbsp;<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ps.setInt(2, post.getUserId());&nbsp;<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lobCreator.setClobAsString(ps, 3, post.getPostText());<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lobCreator.setBlobAsBytes(ps, 4, post.getPostAttach());<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp; });<br style="line-height: normal;">}<br style="line-height: normal;">}</p>
<p style="line-height: normal;">设置相对应的配置文件(Oracle 9i版本),Oracle的数据库最喜欢搞搞特别的东西啦：</p>
<p style="line-height: normal;">&lt;bean id="nativeJdbcExtractor"<br style="line-height: normal;">&nbsp;&nbsp; class="org.springframework.jdbc.support.nativejdbc.CommonsDbcpNativeJdbcExtractor"<br style="line-height: normal;">&nbsp;&nbsp; lazy-init="true" /&gt;<br style="line-height: normal;">&lt;bean id="oracle<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>"<br style="line-height: normal;">&nbsp;&nbsp; class="org.springframework.jdbc.support.lob.Oracle<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>"<br style="line-height: normal;">&nbsp;&nbsp; lazy-init="true"&gt;<br style="line-height: normal;">&nbsp;&nbsp; &lt;property name="nativeJdbcExtractor" ref="nativeJdbcExtractor" /&gt;<br style="line-height: normal;">&lt;/bean&gt;<br style="line-height: normal;">&lt;bean id="dao" abstract="true"&gt;<br style="line-height: normal;">&nbsp;&nbsp; &lt;property name="jdbcTemplate" ref="jdbcTemplate" /&gt;<br style="line-height: normal;">&lt;/bean&gt;<br style="line-height: normal;">&lt;bean id="postDao" parent="dao"<br style="line-height: normal;">&nbsp;&nbsp; class="com.baobaotao.dao.jdbc.PostJdbcDao"&gt;<br style="line-height: normal;">&nbsp;&nbsp; &lt;property name="<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>" ref="oracle<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>" /&gt;<br style="line-height: normal;">&lt;/bean&gt;</p>
<p style="line-height: normal;">Oracle 10g或其他数据库如下设置：</p>
<p style="line-height: normal;">&lt;bean id="default<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>"<br style="line-height: normal;">&nbsp;&nbsp; class="org.springframework.jdbc.support.lob.Default<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>"<br style="line-height: normal;">&nbsp;&nbsp; lazy-init="true" /&gt;<br style="line-height: normal;">&lt;bean id="dao" abstract="true"&gt;<br style="line-height: normal;">&nbsp;&nbsp; &lt;property name="jdbcTemplate" ref="jdbcTemplate" /&gt;<br style="line-height: normal;">&lt;/bean&gt;<br style="line-height: normal;">&lt;bean id="postDao" parent="dao"<br style="line-height: normal;">&nbsp;&nbsp; class="com.baobaotao.dao.jdbc.PostJdbcDao"&gt;<br style="line-height: normal;">&nbsp;&nbsp; &lt;property name="<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>" ref="default<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">LobHandler</span>" /&gt;<br style="line-height: normal;">&lt;/bean&gt;</p>
<p style="line-height: normal;">读取BLOB/CLOB块,举例：</p>
<p style="line-height: normal;">public List getAttachs(final int userId){<br style="line-height: normal;">&nbsp;&nbsp; String sql = "SELECT post_id,post_attach FROM t_post where user_id =? and post_attach is not null";<br style="line-height: normal;">&nbsp;&nbsp; return getJdbcTemplate().query(<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sql,new Object[] {userId},<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new RowMapper() {<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Object mapRow(ResultSet rs, int rowNum) throws SQLException {<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Post post = new Post();<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int postId = rs.getInt(1);<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte[] attach =&nbsp;<span style="line-height: normal; background-color: #ffff00; float: none; color: #000000; padding: 0px; margin: 0px;">lobHandler</span>.getBlobAsBytes(rs, 2);<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; post.setPostId(postId);<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; post.setPostAttach(attach);<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return post;<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br style="line-height: normal;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br style="line-height: normal;">}</p>
<p></p>